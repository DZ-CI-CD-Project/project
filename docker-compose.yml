services:
  # MongoDB 데이터베이스
  mongodb:
    image: mongo:7.0
    container_name: gb_mongodb
    restart: unless-stopped
    # MongoDB 포트 매핑 (로컬 개발용은 27018, 서버 배포는 27017 사용 권장)
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: jobsdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - guestbook_network

  # 백엔드 API 서버
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: gb_backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      NODE_ENV: production
      PORT: 8000
      MONGO_URI: mongodb://mongodb:27017/jobsdb
      JWT_SECRET: ${JWT_SECRET:-your_jwt_secret_key_change_this_in_production}
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-http://localhost:3000}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://192.168.0.208:3000}
      # Work24 OpenAPI 설정
      WORK24_KEY: ${WORK24_KEY:-184d5b92-d9ef-4629-b9dc-1947635119ac}
      WORK24_BASE_URL: ${WORK24_BASE_URL:-https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L21.do}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - guestbook_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8000/api/health', (res) => { if (res.statusCode === 200) process.exit(0); console.error(res.statusCode); process.exit(1); }).on('error', (err) => { console.error(err); process.exit(1); });"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 프론트엔드 웹 서버
  frontend:
    build: 
      context: ./frontend/app
      dockerfile: Dockerfile
    container_name: gb_frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      BACKEND_URL: http://backend:8000
      WORK24_API_KEY: ${WORK24_KEY:-184d5b92-d9ef-4629-b9dc-1947635119ac}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - guestbook_network

volumes:
  mongodb_data:
    name: mongodb_data

networks:
  guestbook_network:
    driver: bridge
