name: Scan, Test, and Deploy to Harbor

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  REGISTRY_HOST: 192.168.0.240
  HARBOR_PROJECT: ${{ vars.HARBOR_PROJECT || 'mywork' }}

jobs:
  sonarqube:
    name: SonarQube Analysis
    needs: [prepare-version]
    runs-on: [self-hosted, Linux, X64]
    env:
      SONAR_PROJECT_VERSION: ${{ needs.prepare-version.outputs.image_version || github.run_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=DZ-CI-CD-Project
            -Dsonar.projectName=DZ-CI-CD-Project
            -Dsonar.projectVersion=${{ env.SONAR_PROJECT_VERSION }}
            -Dsonar.sources=backend,frontend
            -Dsonar.exclusions=**/node_modules/**,**/.next/**,frontend/app/public/**,**/build/**,**/dist/**,**/coverage/**

      - name: Check Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  prepare-version:
    name: Determine Image Version
    runs-on: ubuntu-latest
    outputs:
      image_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        run: |
          git fetch --tags
          latest_tag=$(git tag --list 'v1.*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            next_minor=0
          else
            latest_minor=${latest_tag#v1.}
            next_minor=$((latest_minor + 1))
          fi
          version="1.${next_minor}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build, Scan, and Push Images
    runs-on: [self-hosted, Linux, X64]
    needs: [prepare-version, sonarqube]
    env:
      IMAGE_VERSION: ${{ needs.prepare-version.outputs.image_version }}
      HARBOR_CA_CRT: ${{ secrets.HARBOR_CA_CRT }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_name: backend
            context: backend
            dockerfile: backend/Dockerfile
          - image_name: frontend
            context: frontend/app
            dockerfile: frontend/app/Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Harbor CA certificate
        if: ${{ env.HARBOR_CA_CRT != '' }}
        run: |
          echo "$HARBOR_CA_CRT" | base64 -d > harbor-ca.crt
          sudo mkdir -p /etc/docker/certs.d/${{ env.REGISTRY_HOST }}
          sudo cp harbor-ca.crt /etc/docker/certs.d/${{ env.REGISTRY_HOST }}/ca.crt
          sudo cp harbor-ca.crt /usr/local/share/ca-certificates/harbor.crt
          sudo update-ca-certificates

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Define image reference
        id: image
        run: |
          IMAGE_REF=${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ matrix.image_name }}:${{ env.IMAGE_VERSION }}
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"

      - name: Build image
        run: |
          docker build -f ${{ matrix.dockerfile }} -t ${{ steps.image.outputs.image_ref }} ${{ matrix.context }}

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ steps.image.outputs.image_ref }}
          format: table
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          exit-code: '0'

      - name: Push image
        run: docker push ${{ steps.image.outputs.image_ref }}

      - name: Tag and push latest
        run: |
          docker tag ${{ steps.image.outputs.image_ref }} ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ matrix.image_name }}:latest
          docker push ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ matrix.image_name }}:latest

  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    needs:
      - build-and-push
      - prepare-version
    if: needs.build-and-push.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git fetch --tags

      - name: Create and push tag
        env:
          VERSION: ${{ needs.prepare-version.outputs.image_version }}
        run: |
          TAG="v${VERSION}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            exit 0
          fi
          git tag "$TAG"
          git push origin "$TAG"